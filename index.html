<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Big Little Lies, Big Little Types</title>

    <link rel="stylesheet" href="dist/reset.css">
    <link rel="stylesheet" href="dist/reveal.css">
    <link rel="stylesheet" href="dist/theme/big-little-types.css">

    <!-- Theme used for syntax highlighted code -->
    <!--    <link rel="stylesheet" href="plugin/highlight/monokai.css">-->
</head>
<body>
<div class="reveal">
    <div class="slides">
        <section>
            <section>
                <div class="r-stack">
                    <h1 class="fragment fade-out" data-fragment-index="0">
                        Big Little Lies,<br>
                        Big Little Types
                    </h1>
                    <h2 class="fix-heading-alignment fragment" data-fragment-index="0">
                        Making React More Type Safe With Type-Tagging in Scala.js
                    </h2>
                </div>
                <div class="r-stack">
                    <img class="hero" data-src="assets/big-little-lies.jpg">
                    <img class="logo fragment" data-fragment-index="0" data-src="assets/react-icon.svg"
                         style="position: relative; left: -18%;">
                    <img class="logo fragment" data-fragment-index="0" data-src="assets/scala-js-logo.svg"
                         style="position: relative; left: 2%;">
                    <img class="logo fragment" data-fragment-index="0" data-src="assets/slinky-logo.svg"
                         style="position: relative; top: 5%; left: 19%;">
                </div>
            </section>

            <section>
                <h2>A Bit About Me</h2>
                <ul>
                    <li class="fragment">
                        Jason Pickens (
                        <img class="inline" data-src="assets/github-mark.svg">
                        <a href="https://github.com/steinybot">@steinybot</a>
                        )
                    </li>
                    <li class="fragment">
                        <div>
                            Father of 4 (2 human)
                            <div>
                                <img class="fragment fade-out" data-src="assets/babies.jpg"
                                     style="height: 400px; position: absolute;">
                            </div>
                        </div>
                    </li>
                    <li class="fragment">Graduate at Orion Health in 2010</li>
                    <li class="fragment">First intro to FP and Scala in 2013</li>
                    <li class="fragment">Did a stint at Lightbend</li>
                    <li class="fragment">Went to dinner with the Scala team</li>
                    <li class="fragment">Now at Goodcover</li>
                    <li class="fragment">Writing Scala professionally for ~7 years</li>
                </ul>
            </section>
        </section>
        <section>
            <h2>Teaser</h2>
            <div class="code-overlay-container r-stack">
                <pre><code data-trim data-line-numbers=""><script type="text/template">
import { ReactElement } from "react";

function RedList(props: { children: ReactElement[] }) {
  return <ul style={{ color: "red" }}>{props.children}</ul>;
}

function QuantifiedListItem(props: { children: string; amount: number }) {
  return <li>{props.children} * {props.amount}</li>;
}

export default function App() {
  return (
    <RedList>
      <li>Apple</li>
      <li>Banana</li>
      <QuantifiedListItem amount={5}>Cherries</QuantifiedListItem>
    </RedList>
  );
}
                </script></code></pre>
                <div class="code-overlay fragment r-frame">
                    <ul style="color: red;">
                        <li>Apple</li>
                        <li>Banana</li>
                        <li>Cherries * 5</li>
                    </ul>
                </div>
            </div>
        </section>
        <section>
            <section>
                <h2>React</h2>
                <h3>A JavaScript library for building user interfaces</h3>
                <ul>
                    <li class="fragment">The community has provided TypeScript and Flow definitions</li>
                    <li class="fragment">Often used with JSX</li>
                    <li class="fragment">Concepts: Elements, Components, Props, State, Rendering</li>
                    <li class="fragment">Function and Class Components</li>
                </ul>
            </section>
            <section>
                <h2>React</h2>
                <pre><code data-trim data-line-numbers="4,8,14-15|3,7,11,13,16-17|"><script type="text/template">
import { ReactElement } from "react";

function RedList(props: { children: ReactElement[] }) {
  return <ul style={{ color: "red" }}>{props.children}</ul>;
}

function QuantifiedListItem(props: { children: string; amount: number }) {
  return <li>{props.children} * {props.amount}</li>;
}

export default function App() {
  return (
    <RedList>
      <li>Apple</li>
      <li>Banana</li>
      <QuantifiedListItem amount={5}>Cherries</QuantifiedListItem>
    </RedList>
  );
}
                </script></code></pre>
            </section>
        </section>
        <section>
            <h2>Untyped Children</h2>
            <div class="code-overlay-container r-stack">
                <pre><code data-trim data-line-numbers="3,15"><script type="text/template">
import { ReactElement } from "react";

function RedList(props: { children: ReactElement[] }) {
  return <ul style={{ color: "red" }}>{props.children}</ul>;
}

function QuantifiedListItem(props: { children: string; amount: number }) {
  return <li>{props.children} * {props.amount}</li>;
}

export default function App() {
  return (
    <RedList>
      <li>Apple</li>
      <li>Banana</li>
      <QuantifiedListItem amount={5}>Cherries</QuantifiedListItem>
    </RedList>
  );
}
                </script></code></pre>
                <pre class="fragment"><code data-trim data-line-numbers="3,15"><script type="text/template">
import { ReactElement } from "react";

function RedList(props: { children: ReactElement[] }) {
  return <ul style={{ color: "red" }}>{props.children}</ul>;
}

function QuantifiedListItem(props: { children: string; amount: number }) {
  return <li>{props.children} * {props.amount}</li>;
}

export default function App() {
  return (
    <RedList>
      <li>Apple</li>
      <p>Banana</p>
      <QuantifiedListItem amount={5}>Cherries</QuantifiedListItem>
    </RedList>
  );
}
                </script></code></pre>
                <div class="code-overlay fragment r-frame">
                    <ul style="color: red;">
                        <li>Apple</li>
                        <p>Banana</p>
                        <li>Cherries * 5</li>
                    </ul>
                </div>
            </div>
<!--        <ul>https://flow.org/en/docs/react/children/#toc-only-allowing-a-specific-element-type-as-children</ul>-->
        </section>
        <section>
            <section>
                <h2>Scala.js</h2>
                <h3>Scala for the web</h3>
                <ul>
                    <li class="fragment">Now a built-in target for the Scala compiler</li>
                    <li class="fragment">Outputs .sjsir and .class files</li>
                    <li class="fragment">Scala.js linker produces .js files</li>
                    <li class="fragment">Same semantics as JVM (mostly)</li>
                    <li class="fragment">Very good JavaScript interoperability</li>
                    <li class="fragment">Generate Scala.js facades from TypeScript</li>
                </ul>
            </section>
        </section>
        <section>
            <section>
                <h2>Slinky</h2>
                <pre><code class="language-scala" data-trim data-line-numbers="1|3|5-8|10-11|13|15|17|"><script type="text/template">
val tag: WithAttrs[li.tag.type] = li("Apple")

val renderedTag: ReactElement = tag

val component: FunctionalComponent[Props] =
  FunctionalComponent[Props] { props =>
    li(s"${props.children} * ${props.amount}")
  }

def fn(amount: Int)(children: String) =
  li(s"$children * $amount")

val componentWithProps: KeyAddingStage = component(Props("Cherries", 5))

val componentWithKey: ReactElement = componentWithProps.withKey("cherries")

val renderedComponent: ReactElement = componentWithProps
                </script></code></pre>
            </section>
            <section>
                <h2>Slinky</h2>
                <pre><code class="language-scala" data-trim data-line-numbers="2,5,9,10|1,4,7,8,11|"><script type="text/template">
def RedList(children: ReactElement*) =
  ul(style := js.Dynamic.literal(color = "red"))(children: _*)

def QuantifiedListItem(amount: Int)(children: String) =
  li(s"$children * $amount")

def App =
  RedList(
    li("Apple"),
    li("Banana"),
    QuantifiedListItem(5)("Cherries")
  )
                </script></code></pre>
            </section>
            <section>
                <h2>Slinky</h2>
                <pre style="font-size: 0.4em;"><code class="language-scala" data-trim data-line-numbers="2,3,5,10,11,13,18,21-24|"><script type="text/template">
@react
object RedList {
  case class Props(children: ReactElement*)
  val component = FunctionalComponent[Props] { props =>
    ul(style := js.Dynamic.literal(color = "red"))(props.children: _*)
  }
}

@react
object QuantifiedListItem {
  case class Props(children: String, amount: Int)
  val component = FunctionalComponent[Props] { props =>
    li(s"${props.children} * ${props.amount}")
  }
}

@react
object App {
  type Props = Unit
  val component = FunctionalComponent[Props] { _ =>
    RedList(
      li("Apple"),
      li("Banana"),
      QuantifiedListItem(5)("Cherries")
    )
  }
}
                </script></code></pre>
            </section>
        </section>
        <section>
            <h2>Typed Children</h2>
            <div class="r-stack">
                <pre><code class="language-scala" data-trim data-line-numbers="1,10"><script type="text/template">
def RedList(children: ReactElement*) =
  ul(style := js.Dynamic.literal(color = "red"))(children: _*)

def QuantifiedListItem(amount: Int)(children: String) =
  li(s"$children * $amount")

def App =
  RedList(
    li("Apple"),
    li("Banana"),
    QuantifiedListItem(5)("Cherries")
  )
                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="1,10"><script type="text/template">
def RedList(children: ReactElement*) =
  ul(style := js.Dynamic.literal(color = "red"))(children: _*)

def QuantifiedListItem(amount: Int)(children: String) =
  li(s"$children * $amount")

def App =
  RedList(
    li("Apple"),
    p("Banana"), // This compiles fine üòí
    QuantifiedListItem(5)("Cherries")
  )
                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="1,10"><script type="text/template">
def RedList(children: TypedReactElement[li.tag.type]*) =
  ul(style := js.Dynamic.literal(color = "red"))(children: _*)

def QuantifiedListItem(amount: Int)(children: String) =
  li(s"$children * $amount")

def App =
  RedList(
    li("Apple"),
    p("Banana"), // This fails to compile ü•≥
    QuantifiedListItem(5)("Cherries")
  )
                </script></code></pre>
            </div>
        </section>
        <section>
            <section>
                <h2>Value Class</h2>
                <div class="r-stack">
                    <pre><code class="language-scala" data-line-numbers="1">
<script type="text/template">class TypedReactElement[Result](val element: ReactElement) extends AnyVal












                    </script></code></pre>
                    <pre class="fragment"><code class="language-scala" data-line-numbers="3-5">
<script type="text/template">class TypedReactElement[Result](val element: ReactElement) extends AnyVal

object TypedReactElement {
  implicit def fromTag[Result](tag: WithAttrs[Result]): TypedReactElement[Result] =
    new TypedReactElement(tag)



}




                    </script></code></pre>
                    <pre class="fragment"><code class="language-scala" data-line-numbers="7-8">
<script type="text/template">class TypedReactElement[Result](val element: ReactElement) extends AnyVal

object TypedReactElement {
  implicit def fromTag[Result](tag: WithAttrs[Result]): TypedReactElement[Result] =
    new TypedReactElement(tag)

  implicit def toReactElement(result: TypedReactElement[_]): ReactElement =
    result.asInstanceOf[ReactElement]
}




                    </script></code></pre>
                    <pre class="fragment"><code class="language-scala" data-line-numbers="11-13|">
<script type="text/template">class TypedReactElement[Result](val element: ReactElement) extends AnyVal

object TypedReactElement {
  implicit def fromTag[Result](tag: WithAttrs[Result]): TypedReactElement[Result] =
    new TypedReactElement(tag)

  implicit def toReactElement(result: TypedReactElement[_]): ReactElement =
    result.asInstanceOf[ReactElement]
}

val tag: WithAttrs[li.tag.type] = li("Apple")

val renderedTypedTag: TypedReactElement[li.tag.type] = tag
                    </script></code></pre>
                    <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="1,10"><script type="text/template">
def RedList(children: TypedReactElement[li.tag.type]*) =
  ul(style := js.Dynamic.literal(color = "red"))(children: _*)

def QuantifiedListItem(amount: Int)(children: String) =
  li(s"$children * $amount")

def App =
  RedList(
    li("Apple"),
    p("Banana"), // This fails to compile ü•≥
    QuantifiedListItem(5)("Cherries")
  )
                    </script></code></pre>
                </div>
            </section>
            <section>
                <h2>Unexpected Allocation</h2>
                <pre><code class="language-plaintext" data-trim data-line-numbers="7"><script type="text/template">
49: invokevirtual #217  // Method slinky/web/html/li$.apply:(Lscala/collection/immutable/Seq;)Lscala/scalajs/js/Array;
52: invokevirtual #220  // Method Demo$TypedReactElement$.apply:(Lscala/scalajs/js/Array;)Lslinky/core/facade/ReactElement;
55: invokespecial #244  // Method Demo$TypedReactElement."<init>":(Lslinky/core/facade/ReactElement;)V
58: aastore
59: dup
60: iconst_1
61: new           #10   // class Demo$TypedReactElement
                </script></code></pre>
            </section>
        </section>
        <section>
            <h2>What About WithAttrs?</h2>
            <pre><code class="language-scala" data-trim data-line-numbers="1,10"><script type="text/template">
def RedList(children: WithAttrs[li.tag.type]*) =
  ul(style := js.Dynamic.literal(color = "red"))(children: _*)

def QuantifiedListItem(amount: Int)(children: String) =
  li(s"$children * $amount")

def App =
  RedList(
    li("Apple"),
    p("Banana"), // This also fails to compile ü§î
    QuantifiedListItem(5)("Cherries")
  )
            </script></code></pre>
        </section>
        <section>
            <h2>Remember KeyAddingStage?</h2>
            <div class="r-stack">
                <pre><code class="language-scala" data-trim data-line-numbers="14-16"><script type="text/template">
def RedList(children: TypedReactElement[li.tag.type]*) =
  ul(style := js.Dynamic.literal(color = "red"))(children)


def QuantifiedListItem(amount: Int)(children: String) =
  li(s"$children * $amount")





def App =
  RedList(
    li("Apple", key := "apple"),
    li("Banana", key := "banana"),
    QuantifiedListItem(5)("Cherries") // Where does the key go?
  )
                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="4-10,16"><script type="text/template">
def RedList(children: TypedReactElement[li.tag.type]*) =
  ul(style := js.Dynamic.literal(color = "red"))(children)

@react
object QuantifiedListItem {
  case class Props(amount: Int, children: String)
  val component = FunctionalComponent[Props] { props =>
    li(s"${props.children} * ${props.amount}")
  }
}

def App =
  RedList(
    li("Apple", key := "apple"),
    li("Banana", key := "banana"),
    QuantifiedListItem(5)("Cherries").withKey("cherries")
  )
                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="1,16"><script type="text/template">
def RedList(children: TypedReactElement[li.tag.type]*) =
  ul(style := js.Dynamic.literal(color = "red"))(children)

@react
object QuantifiedListItem {
  case class Props(amount: Int, children: String)
  val component = FunctionalComponent[Props] { props =>
    li(s"${props.children} * ${props.amount}")
  }
}

def App =
  RedList(
    li("Apple", key := "apple"),
    li("Banana", key := "banana"),
    QuantifiedListItem(5)("Cherries").withKey("cherries") // The type was lost ü§¶
  )
                </script></code></pre>
            </div>
        </section>
        <section>
            <h2>TypedKeyAddingStage?</h2>
            <div class="r-stack">
                <pre><code class="language-scala" data-trim data-line-numbers=""><script type="text/template">
class TypedKeyAddingStage[Result](val stage: KeyAddingStage) extends AnyVal

                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers=""><script type="text/template">
class TypedKeyAddingStage[Result](val stage: KeyAddingStage) extends AnyVal
// value class may not wrap another user-defined value class üò†
                </script></code></pre>
            </div>
        </section>
        <section>
            <h2>Type Alias</h2>
            <div class="r-stack">
                <pre><code class="language-scala" data-line-numbers="1">
<script type="text/template">trait Tag[Result]
















                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-line-numbers="3">
<script type="text/template">trait Tag[Result]

type TypedKeyAddingStage[Result] = KeyAddingStage with Tag[Result]














                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-line-numbers="5-8">
<script type="text/template">trait Tag[Result]

type TypedKeyAddingStage[Result] = KeyAddingStage with Tag[Result]

object TypedKeyAddingStage {
  def unsafe[Result](stage: KeyAddingStage) =
    stage.asInstanceOf[TypedKeyAddingStage[Result]]
}









                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-line-numbers="10-13">
<script type="text/template">trait Tag[Result]

type TypedKeyAddingStage[Result] = KeyAddingStage with Tag[Result]

object TypedKeyAddingStage {
  def unsafe[Result](stage: KeyAddingStage) =
    stage.asInstanceOf[TypedKeyAddingStage[Result]]
}

val cherries: KeyAddingStage = QuantifiedListItem(5)("Cherries")

val typedCherries: TypedKeyAddingStage[li.tag.type] =
  TypedKeyAddingStage.unsafe(cherries)




                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-line-numbers="15-18|">
<script type="text/template">trait Tag[Result]

type TypedKeyAddingStage[Result] = KeyAddingStage with Tag[Result]

object TypedKeyAddingStage {
  def unsafe[Result](stage: KeyAddingStage) =
    stage.asInstanceOf[TypedKeyAddingStage[Result]]
}

val cherries: KeyAddingStage = QuantifiedListItem(5)("Cherries")

val typedCherries: TypedKeyAddingStage[li.tag.type] =
  TypedKeyAddingStage.unsafe(cherries)

val fruit: Seq[TypedKeyAddingStage[li.tag.type]] = Seq(typedCherries)

val firstFruit: TypedKeyAddingStage[li.tag.type] = fruit.head
                </script></code></pre>
            </div>
            <pre class="fragment"><code class="language-plaintext" data-trim style="color: #d3423e;"><script type="text/template">
org.scalajs.linker.runtime.UndefinedBehaviorError:
java.lang.ClassCastException: object cannot be cast to slinky.core.KeyAddingStage
            </script></code></pre>
        </section>
        <section>
            <section>
                <h2>Structural Refinement</h2>
                <div class="r-stack">
                    <pre><code class="language-scala" data-line-numbers="1-3,7">
<script type="text/template">



trait Tag[Result]

type TypedKeyAddingStage[Result] = KeyAddingStage with Tag[Result]

object TypedKeyAddingStage {
  def unsafe[Result](stage: KeyAddingStage) =
    stage.asInstanceOf[TypedKeyAddingStage[Result]]
}

val cherries      = QuantifiedListItem(5)("Cherries")
val typedCherries = TypedKeyAddingStage.unsafe(cherries)
val fruit         = Seq(typedCherries)
val firstFruit    = fruit.head
                    </script></code></pre>
                    <pre class="fragment"><code class="language-scala" data-line-numbers="1-3,7|">
<script type="text/template">type Base = {
  type __TypedKeyAddingStage
}

trait Tag[Result]

type TypedKeyAddingStage[Result] = Base with KeyAddingStage with Tag[Result]

object TypedKeyAddingStage {
  def unsafe[Result](stage: KeyAddingStage) =
    stage.asInstanceOf[TypedKeyAddingStage[Result]]
}

val cherries      = QuantifiedListItem(5)("Cherries")
val typedCherries = TypedKeyAddingStage.unsafe(cherries)
val fruit         = Seq(typedCherries)
val firstFruit    = fruit.head
                    </script></code></pre>
                </div>
            </section>
            <section>
                <h2>Avoiding Allocation</h2>
                <pre><code class="language-diff" data-trim><script type="text/template">
 14: invokevirtual #54        // Method bll/DemoSpec$TypedKeyAddingStage$.unsafe:
-                             //   (Lscala/scalajs/js/Array;)Lscala/scalajs/js/Array;
+                             //   (Lscala/scalajs/js/Array;)Ljava/lang/Object;
 ...
 31: invokeinterface #71,  1  // InterfaceMethod scala/collection/immutable/Seq.head:
                              //   ()Ljava/lang/Object;
-36: checkcast     #73        // class slinky/core/KeyAddingStage
-39: invokevirtual #77        // Method slinky/core/KeyAddingStage.slinky$core$KeyAddingStage$$args:
-                             //   ()Lscala/scalajs/js/Array;
                </script></code></pre>
            </section>
        </section>
        <section>
            <h2>Extension Methods</h2>
            <div class="r-stack">
                <pre><code class="language-scala" data-trim data-line-numbers="16"><script type="text/template">
def RedList(children: TypedReactElement[li.tag.type]*) =
  ul(style := js.Dynamic.literal(color = "red"))(children)

@react
object QuantifiedListItem {
  case class Props(amount: Int, children: String)
  val component = FunctionalComponent[Props] { props =>
    li(s"${props.children} * ${props.amount}")
  }
}

def App =
  RedList(
    li("Apple", key := "apple"),
    li("Banana", key := "banana"),
    QuantifiedListItem(5)("Cherries").withKey("cherries") // The type was lost ü§¶
  )
                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers=""><script type="text/template">
type Base = {
  type __TypedKeyAddingStage
}

trait Tag[Result]








type TypedKeyAddingStage[Result] = Base with KeyAddingStage with Tag[Result]

object TypedKeyAddingStage {
  def unsafe[Result](stage: KeyAddingStage) =
    stage.asInstanceOf[TypedKeyAddingStage[Result]]
}
                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="7-12|"><script type="text/template">
type Base = {
  type __TypedKeyAddingStage
}

trait Tag[Result]

object Tag {
  implicit class Ops[Result](stage: TypedKeyAddingStage[Result]) {
    @inline def withKeyTyped(key: String): TypedReactElement[Result] =
      new TypedReactElement[Result](stage.asInstanceOf[KeyAddingStage].withKey(key))
  }
}

type TypedKeyAddingStage[Result] = Base with KeyAddingStage with Tag[Result]

object TypedKeyAddingStage {
  def unsafe[Result](stage: KeyAddingStage) =
    stage.asInstanceOf[TypedKeyAddingStage[Result]]
}
                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="16"><script type="text/template">
def RedList(children: TypedReactElement[li.tag.type]*) =
  ul(style := js.Dynamic.literal(color = "red"))(children)

@react
object QuantifiedListItem {
  case class Props(amount: Int, children: String)
  val component = FunctionalComponent[Props] { props =>
    li(s"${props.children} * ${props.amount}")
  }
}

def App =
  RedList(
    li("Apple", key := "apple"),
    li("Banana", key := "banana"),
    QuantifiedListItem(5)("Cherries").withKey("cherries") // The type was lost ü§¶
  )
                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="16"><script type="text/template">
def RedList(children: TypedReactElement[li.tag.type]*) =
  ul(style := js.Dynamic.literal(color = "red"))(children)

@react
object QuantifiedListItem {
  case class Props(amount: Int, children: String)
  val component = FunctionalComponent[Props] { props =>
    li(s"${props.children} * ${props.amount}")
  }
}

def App =
  RedList(
    li("Apple", key := "apple"),
    li("Banana", key := "banana"),
    TypedKeyAddingStage.unsafe(QuantifiedListItem(5)("Cherries"))
      .withKeyTyped("cherries")
  )
                </script></code></pre>
            </div>
        </section>
        <section>
            <h2>TypedFunctionalComponent</h2>
            <div class="r-stack">
                <pre><code class="language-scala" data-line-numbers="1-6">
<script type="text/template">class FunctionalComponent[Props](val component: js.Function) extends AnyVal with
  FunctionalComponentCore[
    Props,
    KeyAddingStage,
    FunctionalComponent[Props]
  ]







                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-line-numbers="1,8|4,11|">
<script type="text/template">class FunctionalComponent[Props](val component: js.Function) extends AnyVal with
  FunctionalComponentCore[
    Props,
    KeyAddingStage,
    FunctionalComponent[Props]
  ]

type TypedFunctionalComponent[Props, Result] =
  FunctionalComponentCore[
    Props,
    TypedKeyAddingStage[Result],
    FunctionalComponent[Props]
  ]
                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-line-numbers="1-5">
<script type="text/template">object FunctionalComponent {
  def apply[Props](fn: Props => ReactElement):
    FunctionalComponent[Props] =
      new FunctionalComponent[Props](???)
}







                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="1,7|2,8|3,9|4,10-11|"><script type="text/template">
object FunctionalComponent {
  def apply[Props](fn: Props => ReactElement):
    FunctionalComponent[Props] =
      new FunctionalComponent[Props](???)
}

object TypedFunctionalComponent {
  def apply[Props, Result](fn: Props => TypedReactElement[Result]):
    TypedFunctionalComponent[Props, Result] =
      FunctionalComponent(fn.andThen(_.element))
        .asInstanceOf[TypedFunctionalComponent[Props, Result]]
}
                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="7|16|"><script type="text/template">
def RedList(children: TypedReactElement[li.tag.type]*) =
  ul(style := js.Dynamic.literal(color = "red"))(children)

@react
object QuantifiedListItem {
  case class Props(amount: Int, children: String)
  val component = TypedFunctionalComponent[Props, li.tag.type] { props =>
    li(s"${props.children} * ${props.amount}")
  }
}

def App =
  RedList(
    li("Apple", key := "apple"),
    li("Banana", key := "banana"),
    QuantifiedListItem(5)("Cherries").withKeyTyped("cherries")
  )
                </script></code></pre>
            </div>
        </section>
        <section>
            <section>
                <h2>Refined Types</h2>
                <div class="r-stack">
                    <pre><code class="language-scala" data-line-numbers="18">
<script type="text/template">




@react
object QuantifiedListItem {
  case class Props(amount: Int, children: String)
  val component = TypedFunctionalComponent[Props, li.tag.type] { props =>
    li(s"${props.children} * ${props.amount}")
  }
}

def App =
  RedList(
    li("Apple"),
    li("Banana"),
    QuantifiedListItem(-2)(" ") // We can do better üßê
  )
                    </script></code></pre>
                    <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="1-4,8,18"><script type="text/template">
object ItemTypes {
  type ItemAmount = PosInt
  type ItemName = String Refined (Trimmed And NonEmpty)
}

@react
object QuantifiedListItem {
  case class Props(amount: ItemAmount, children: ItemName)
  val component = TypedFunctionalComponent[Props, li.tag.type] { props =>
    li(s"${props.children} * ${props.amount}")
  }
}

def App =
  RedList(
    li("Apple"),
    li("Banana"),
    QuantifiedListItem(-2)(" ") // Fails to compile üí™
  )
                    </script></code></pre>
                    <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="18|"><script type="text/template">
object ItemTypes {
  type ItemAmount = PosInt
  type ItemName = String Refined (Trimmed And NonEmpty)
}

@react
object QuantifiedListItem {
  case class Props(amount: ItemAmount, children: ItemName)
  val component = TypedFunctionalComponent[Props, li.tag.type] { props =>
    li(s"${props.children} * ${props.amount}")
  }
}

def App =
  RedList(
    li("Apple"),
    li("Banana"),
    QuantifiedListItem(5)("Cherries") // Compiles üéâ
  )
                    </script></code></pre>
                </div>
            </section>
            <section>
                <h2>Inside Refined</h2>
                <pre><code class="language-scala" data-trim data-line-numbers="1|3-6|8-11|"><script type="text/template">
class Refined[T, P](val value: T) extends AnyVal

implicit def autoRefineV[T, P](t: T)(implicit
    rt: RefType[Refined],
    v: Validate[T, P]
): Refined[T, P] = macro RefineMacro.impl[Refined, T, P]

object Trimmed {
  implicit def trimmedValidate: Validate.Plain[String, Trimmed] =
    Validate.fromPredicate(s => s.trim == s, t => s"$t is trimmed", Trimmed())
}
                </script></code></pre>
            </section>
        </section>
        <section>
            <h2>Unsafe Hooks</h2>
            <pre><code class="language-scala" data-trim data-line-numbers="2|3|5,9|6|7|8|11|"><script type="text/template">
val component = FunctionalComponent[Unit] { _ =>
  val (messages, setMessages) = useState(Vector.empty[String])
  val (params, setParams) = useState(Params("", 10))

  useEffect(() => {
    setMessages(_ :+ s"Loading data with params: $params")
    val handle = setTimeout(1.seconds)(setMessages(_ :+ "Data loaded."))
    () => clearTimeout(handle)
  })

  textarea(readOnly := true, value := messages.mkString("\n"))
}
            </script></code></pre>
            <pre class="fragment"><code class="language-plaintext" data-trim style="color: #DCDCAA;"><script type="text/template">
//Warning: Maximum update depth exceeded.
//  This can happen when a component calls setState inside useEffect,
//  but useEffect either doesn't have a dependency array,
//  or one of the dependencies changes on every render.
            </script></code></pre>
        </section>
                <section>
            <h2>Safer Hooks</h2>
            <div class="r-stack">
                 <pre><code class="language-scala" data-trim data-line-numbers="9"><script type="text/template">
val component = FunctionalComponent[Unit] { _ =>
  val (messages, setMessages) = useState(Vector.empty[String])
  val (params, setParams) = useState(Params("", 10))

  useEffect(() => {
    setMessages(_ :+ s"Loading data with params: $params")
    val handle = setTimeout(1.seconds)(setMessages(_ :+ "Data loaded."))
    () => clearTimeout(handle)
  })

  textarea(readOnly := true, value := messages.mkString("\n"))
}
                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="9|"><script type="text/template">
val component = FunctionalComponent[Unit] { _ =>
  val (messages, setMessages) = useState(Vector.empty[String])
  val (params, setParams) = useState(Params("", 10))

  useEffect(() => {
    setMessages(_ :+ s"Loading data with params: $params")
    val handle = setTimeout(1.seconds)(setMessages(_ :+ "Data loaded."))
    () => clearTimeout(handle)
  }, Seq(params))

  textarea(readOnly := true, value := messages.mkString("\n"))
}
                </script></code></pre>
            </div>
            <div class="fragment">
                <textarea readonly style="margin-top: 25px; width: 600px; font-size: 0.5em">Loading data with params: Params(,10)
Data loaded.</textarea>
            </div>
        </section>
        <section>
            <h2>Safe...err Hooks</h2>
            <div class="r-stack">
                <div style="width: 100%;">
                    <div class="r-stack">
                        <pre><code class="language-scala" data-trim data-line-numbers=""><script type="text/template">
val component = FunctionalComponent[Unit] { _ =>
  val (messages, setMessages) = useState(Vector.empty[String])
  val (params, setParams) = useState(Params("", 10))





  useEffect(() => {
    setMessages(_ :+ s"Loading data with params: $params")
    val handle = setTimeout(1.seconds)(setMessages(_ :+ "Data loaded."))
    () => clearTimeout(handle)
  }, Seq(params))

  textarea(readOnly := true, value := messages.mkString("\n"))
}
                        </script></code></pre>
                        <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="5-7,13|"><script type="text/template">
val component = FunctionalComponent[Unit] { _ =>
  val (messages, setMessages) = useState(Vector.empty[String])
  val (params, setParams) = useState(Params("", 10))

  val paramsWithDefaults = params.copy(
    text = if (params.text.nonEmpty) params.text else "foo"
  )

  useEffect(() => {
    setMessages(_ :+ s"Loading data with params: $paramsWithDefaults")
    val handle = setTimeout(1.seconds)(setMessages(_ :+ "Data loaded."))
    () => clearTimeout(handle)
  }, Seq(paramsWithDefaults))

  textarea(readOnly := true, value := messages.mkString("\n"))
}
                        </script></code></pre>
                    </div>
                    <pre class="fragment fade-in-then-out fade-to-nothing"><code class="language-plaintext" data-trim style="color: #DCDCAA;"><script type="text/template">
//Warning: Maximum update depth exceeded...
                    </script></code></pre>
                </div>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="5-7|"><script type="text/template">
val component = FunctionalComponent[Unit] { _ =>
  val (messages, setMessages) = useState(Vector.empty[String])
  val (params, setParams) = useState(Params("", 10))

  val paramsWithDefaults = useMemo(() => params.copy(
    text = if (params.text.nonEmpty) params.text else "foo"
  ), Seq(params))

  useEffect(() => {
    setMessages(_ :+ s"Loading data with params: $paramsWithDefaults")
    val handle = setTimeout(1.seconds)(setMessages(_ :+ "Data loaded."))
    () => clearTimeout(handle)
  }, Seq(paramsWithDefaults))

  textarea(readOnly := true, value := messages.mkString("\n"))
}
                </script></code></pre>
            </div>
        </section>
        <section>
            <h2>Stable Tag</h2>
             <pre><code class="language-scala" data-trim data-line-numbers="1|5-7|9|11|13-14|"><script type="text/template">
type Stable[A] = Stable.Type[A]

object Stable {

  type Base = {
    type __Stable
  }

  sealed trait Tag extends Any

  type Type[A] <: Base with A with Tag

  def byReference[A](a: A): Stable[A] =
    a.asInstanceOf[Stable[A]]
}
            </script></code></pre>
        </section>
        <section>
            <h2>Safety Hooks</h2>
            <pre><code class="language-scala" data-trim data-line-numbers="1-3|5-7|9-12|14-18|"><script type="text/template">
def useEffect(thunk: () => Unit,
              dependencies: Iterable[Stable[_]]): Unit =
  Hooks.useEffect(thunk, dependencies)

def useEffectCancellable(thunk: () => () => Unit,
                         dependencies: Iterable[Stable[_]]): Unit =
  Hooks.useEffect(thunk, dependencies)

def useState[A](initial: A): (Stable[A], SetStateHookCallback[A]) = {
  val (state, setState) = Hooks.useState(initial)
  (Stable.byReference(state), setState)
}

def useMemo[A](memoValue: () => A,
               dependencies: Iterable[Stable[_]]): Stable[A] = {
  val value = Hooks.useMemo[A](memoValue, dependencies)
  Stable.byReference(value)
}
            </script></code></pre>
        </section>
        <section>
            <h2>Safest Hooks</h2>
            <div class="r-stack">
                 <pre><code class="language-scala" data-trim data-line-numbers="5-7,13"><script type="text/template">
val component = FunctionalComponent[Unit] { _ =>
  val (messages, setMessages) = useState(Vector.empty[String])
  val (params, setParams) = useState(Params("", 10))

  val paramsWithDefaults = params.copy(
    text = if (params.text.nonEmpty) params.text else "foo"
  )

  useEffect(() => {
    setMessages(_ :+ s"Loading data with params: $paramsWithDefaults")
    val handle = setTimeout(1.seconds)(setMessages(_ :+ "Data loaded."))
    () => clearTimeout(handle)
  }, Seq(paramsWithDefaults)) // Fails to compile ü§ò

  textarea(readOnly := true, value := messages.mkString("\n"))
}
                </script></code></pre>
                <pre class="fragment"><code class="language-scala" data-trim data-line-numbers="1-3|5-7|9-12|14-18|"><script type="text/template">
val component = FunctionalComponent[Unit] { _ =>
  val (messages, setMessages) = useState(Vector.empty[String])
  val (params, setParams) = useState(Params("", 10))

  val paramsWithDefaults = useMemo(() => params.copy(
    text = if (params.text.nonEmpty) params.text else "foo"
  ), Seq(params))

  useEffect(() => {
    setMessages(_ :+ s"Loading data with params: $paramsWithDefaults")
    val handle = setTimeout(1.seconds)(setMessages(_ :+ "Data loaded."))
    () => clearTimeout(handle)
  }, Seq(paramsWithDefaults)) // Compiles üòè

  textarea(readOnly := true, value := messages.mkString("\n"))
}
                </script></code></pre>
            </div>
        </section>
        <section>
            <h2>Big Little Types</h2>
            <ul>
                <li></li>
            </ul>
        </section>
    </div>
</div>

<script src="dist/reveal.js"></script>
<script src="plugin/notes/notes.js"></script>
<script src="plugin/markdown/markdown.js"></script>
<script src="plugin/highlight/highlight.js"></script>
<script>
    // More info about initialization & config:
    // - https://revealjs.com/initialization/
    // - https://revealjs.com/config/
    Reveal.initialize({
        hash: true,

        // NOTE: Fix the hero height if changing this.
        width: 1440,
        // margin: 0.05,

        // Learn about plugins: https://revealjs.com/plugins/
        plugins: [RevealMarkdown, RevealHighlight, RevealNotes]
    });
</script>
</body>
</html>
